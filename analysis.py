import database as db
import pandas as pd

def analyze_period(user_id, days=None):
    rows = db.get_history(user_id, days)
    period_name = f"{days} –¥–Ω–µ–π" if days else "–í—Å—ë –≤—Ä–µ–º—è"
    
    if not rows or len(rows) < 2:
        return "üìâ –ë—Ä–∞—Ç, –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –¥–Ω—è –∑–∞–ø–∏—Å–µ–π –≤–µ—Å–∞ –∏ –µ–¥—ã, —á—Ç–æ–±—ã —è —Å–¥–µ–ª–∞–ª –≤—ã–≤–æ–¥—ã."

    # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É (—Ç—É—Ç —Ç–µ–ø–µ—Ä—å 5 –∫–æ–ª–æ–Ω–æ–∫)
    df = pd.DataFrame(rows, columns=['date', 'weight', 'in', 'out', 'limit'])
    
    # –ß–∏–Ω–∏–º –≤–µ—Å
    df['weight'] = pd.to_numeric(df['weight'], errors='coerce')
    df['weight'] = df['weight'].interpolate().bfill()
    
    # --- –î–ê–ù–ù–´–ï –ó–ê –ü–ï–†–ò–û–î ---
    start_weight = df.iloc[0]['weight']
    end_weight = df.iloc[-1]['weight']
    
    # –†–ï–ê–õ–¨–ù–û–°–¢–¨: –°–∫–æ–ª—å–∫–æ —Ç—ã —Å–∫–∏–Ω—É–ª –ø–æ –≤–µ—Å–∞–º
    actual_loss_kg = start_weight - end_weight 
    
    # –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê: –°–∫–æ–ª—å–∫–æ —Ç—ã –¥–æ–ª–∂–µ–Ω –±—ã–ª —Å–∫–∏–Ω—É—Ç—å –ø–æ –∑–∞–ø–∏—Å—è–º
    # –°—á–∏—Ç–∞–µ–º –¥–µ—Ñ–∏—Ü–∏—Ç –∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
    bmr = 1950
    # –î–µ—Ñ–∏—Ü–∏—Ç = (BMR + –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å) - –ï–¥–∞
    df['calc_deficit'] = (bmr + df['out']) - df['in']
    
    # –°—É–º–º–∞—Ä–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç –∑–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥
    total_deficit_kcal = df['calc_deficit'].sum()
    
    # –ü–µ—Ä–µ–≤–æ–¥–∏–º –¥–µ—Ñ–∏—Ü–∏—Ç –∫–∫–∞–ª –≤ –∂–∏—Ä (1 –∫–≥ = 7700 –∫–∫–∞–ª)
    expected_loss_kg = total_deficit_kcal / 7700
    
    # --- –í–ï–†–î–ò–ö–¢ ---
    # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –û–∂–∏–¥–∞–Ω–∏–µ –∏ –†–µ–∞–ª—å–Ω–æ—Å—Ç—å
    # –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –Ω–µ–±–æ–ª—å—à–∞—è (–¥–æ 0.5 –∫–≥) - –≤—Å—ë —á–µ—Ç–∫–æ.
    diff = actual_loss_kg - expected_loss_kg
    
    verdict = ""
    if abs(diff) < 0.4:
        verdict = "‚úÖ <b>–ò–¥–µ–∞–ª—å–Ω–æ.</b> –¢–≤–æ–π –æ—Ä–≥–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —á–∞—Å—ã. –ó–∞–ø–∏—Å–∏ –≤–µ—Ä–Ω—ã–µ."
    elif diff > 0.4:
        # –°–∫–∏–Ω—É–ª –ë–û–õ–¨–®–ï, —á–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª (–∏–ª–∏ –≤–æ–¥–∞ —É—à–ª–∞)
        verdict = "üöÄ <b>–°–∫–∏–Ω—É–ª –±–æ–ª—å—à–µ, —á–µ–º –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ.</b>\n–õ–∏–±–æ —É—à–ª–∞ –≤–æ–¥–∞, –ª–∏–±–æ —Ç—ã —Ç—Ä–∞—Ç–∏—à—å –±–æ–ª—å—à–µ –∫–∞–ª–æ—Ä–∏–π, —á–µ–º –∑–∞–ø–∏—Å—ã–≤–∞–µ—à—å (—ç—Ç–æ —Ö–æ—Ä–æ—à–æ)."
    else:
        # diff < -0.4 (–°–∫–∏–Ω—É–ª –ú–ï–ù–¨–®–ï, —á–µ–º –¥–æ–ª–∂–µ–Ω –±—ã–ª, –∏–ª–∏ –Ω–∞–±—Ä–∞–ª)
        verdict = "‚ö†Ô∏è <b>–ß—Ç–æ-—Ç–æ –Ω–µ —Å—Ö–æ–¥–∏—Ç—Å—è.</b>\n–ü–æ –∑–∞–ø–∏—Å—è–º —Ç—ã –¥–æ–ª–∂–µ–Ω —Ö—É–¥–µ—Ç—å –±—ã—Å—Ç—Ä–µ–µ. –ü—Ä–∏—á–∏–Ω—ã:\n1. –ó–∞–Ω–∏–∂–∞–µ—à—å –µ–¥—É (—Å–æ—É—Å—ã, –ø–µ—Ä–µ–∫—É—Å—ã?).\n2. –ó–∞–≤—ã—à–∞–µ—à—å —Ä–∞—Å—Ö–æ–¥ –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö.\n3. –ó–∞–¥–µ—Ä–∂–∫–∞ –≤–æ–¥—ã (—Å–æ–ª–µ–Ω–æ–µ –µ–ª?)."

    # –ö—Ä–∞—Å–∏–≤—ã–µ —Ü–∏—Ñ—Ä—ã
    actual_sign = "-" if actual_loss_kg > 0 else "+"
    exp_sign = "-" if expected_loss_kg > 0 else "+"
    
    text = (
        f"üß† <b>–ê–ù–ê–õ–ò–ó ({period_name}):</b>\n\n"
        f"1Ô∏è‚É£ <b>–†–ï–ê–õ–¨–ù–û–°–¢–¨ (–í–µ—Å—ã):</b>\n"
        f"–ë—ã–ª–æ: {start_weight} -> –°—Ç–∞–ª–æ: {end_weight}\n"
        f"–†–µ–∑—É–ª—å—Ç–∞—Ç: <b>{actual_sign}{abs(actual_loss_kg):.2f} –∫–≥</b>\n\n"
        
        f"2Ô∏è‚É£ <b>–ú–ê–¢–ï–ú–ê–¢–ò–ö–ê (–¢–≤–æ–∏ –∑–∞–ø–∏—Å–∏):</b>\n"
        f"–¢—ã –Ω–∞–∫–æ–ø–∏–ª –¥–µ—Ñ–∏—Ü–∏—Ç: {total_deficit_kcal:.0f} –∫–∫–∞–ª\n"
        f"–î–æ–ª–∂–µ–Ω –±—ã–ª —Å–∫–∏–Ω—É—Ç—å: <b>{exp_sign}{abs(expected_loss_kg):.2f} –∫–≥</b>\n\n"
        
        f"üßê <b>–í–ï–†–î–ò–ö–¢:</b>\n"
        f"{verdict}"
    )
    
    return text